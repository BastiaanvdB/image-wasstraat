process-syft:
  stage: sbom report process
  needs:
    - syft-scan
  image: quay.io/bastiaanvanderbijl/python:3.12.3-slim
  script:
    - pip install pandas
    - |
      python - <<EOF
      import json
      import pandas as pd

      def load_json_report(file_path):
          with open(file_path) as f:
              return json.load(f)

      # Load the Syft report
      syft_report = load_json_report('reports/syft-report.json')

      # Process Syft report
      packages_data = []
      files_data = []

      # Extract distro information
      distro_data = syft_report.get('distro', {})

      # Process packages data
      for artifact in syft_report['artifacts']:
          packages_data.append({
              'name': artifact['name'],
              'version': artifact['version'],
              'type': artifact['type'],
              'architecture': artifact['metadata'].get('architecture', None),
              'maintainer': artifact['metadata'].get('maintainer', None),
              'installedSize': artifact['metadata'].get('installedSize', None),
              'locations': [location['path'] for location in artifact['locations']]
          })

      # Process files data
      for file in syft_report.get('files', []):
          files_data.append({
              'path': file.get('location', {}).get('path', None),
              'mode': file.get('metadata', {}).get('mode', None),
              'type': file.get('metadata', {}).get('type', None),
              'userid': file.get('metadata', {}).get('userID', None),
              'groupid': file.get('metadata', {}).get('groupID', None),
              'mimeType': file.get('metadata', {}).get('mimeType', None),
              'size': file.get('metadata', {}).get('size', None)
          })

      # Save processed data
      processed_data = {
          'packages': packages_data,
          'files': files_data,
          'distro': distro_data
      }
      with open('reports/processed_syft_report.json', 'w') as f:
          json.dump(processed_data, f, indent=4)
      EOF
  artifacts:
    paths:
      - reports/processed_syft_report.json
  dependencies:
    - syft-scan
  allow_failure: false
