default:
  image: docker:26.1.3
  services:
    - name: docker:26.1.3-dind
      alias: docker-dind

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker-dind:2375/
  DOCKER_DRIVER: overlay2

falco-scan:
  stage: dynamic security scan
  needs: [initialize-job]
  services:
    - name: docker:26.1.3-dind
      alias: docker-dind-falco
  variables:
    DOCKER_HOST: tcp://docker-dind-falco:2375/
  script:
    - echo "Current working directory: $(pwd)"
    - ls -la "$(pwd)/ci/dynamic security scan/config/"
    - docker run --rm -d --name falco -v /var/run/docker.sock:/host/var/run/docker.sock -v /dev:/host/dev -v /proc:/host/proc -v /boot:/host/boot -v /lib/modules:/host/lib/modules -v /usr:/host/usr -v "$(pwd)/ci/dynamic security scan/config/falco_rules.yaml:/etc/falco/falco_rules.local.yaml" falcosecurity/falco -o json_output=true
    - docker ps -a
    - docker run --rm --name test-container $IMAGE_NAME:$IMAGE_TAG
    - sleep 30  # Allow some time for Falco to monitor the container
    - if [ $(docker ps -q -f name=falco) ]; then echo "Falco container is running"; else echo "Falco container is not running"; fi
    - mkdir -p /report
    - docker logs falco > /report/falco-report.json
  artifacts:
    paths:
      - /report/falco-report.json

after_script:
  - docker stop falco || true
  - docker rm falco || true
  - docker rm test-container || true

