default:
  image: docker:26.1.3
  services:
    - name: docker:26.1.3-dind
      alias: docker-dind

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker-dind:2375/
  DOCKER_DRIVER: overlay2


dockle-scan:
  stage: dockle scan
  needs: [initialize-job]
  services:
    - name: docker:26.1.3-dind
      alias: docker-dind-dockle
  variables:
    DOCKER_HOST: tcp://docker-dind-dockle:2375/
  before_script:
    - while ! docker info; do sleep 1; done 
  script:
    - mkdir -p reports
    - docker run --rm -v $(pwd)/reports:/tmp/reports quay.io/bastiaanvanderbijl/dockle -f json -o /tmp/reports/dockle-report.json $IMAGE_NAME:$IMAGE_TAG
  artifacts:
    paths:
      - reports/
  allow_failure: true
